# This workflow is a scheduled workflow and used for deploying the preview version of OpenSearch
# and OpenSearch Dashboards to AWS EKS (Elastic Kubernetes Service) cluster.
name: Scheduled Deploy OpenSearch and OpenSearch Dashboards

on:
  push:
    branches: [ previewchangefeature ]
  # Adds workflow_dispatch for manually running a workflow
  workflow_dispatch:
  schedule:
    # Run every night at 21:30 PDT.
    - cron:  '30 21 * * *'
jobs:

  OS-OSD-Preview-Scheduled-Deployment:
    uses: opensearch-project/dashboards-anywhere/.github/workflows/deployment-template.yml@previewchangefeature
    with:
      helm-repo: https://opensearch-project.github.io/helm-charts/
      deploy-env: preview
    secrets:
      access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PREVIEW }}
      secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PREVIEW }}
      region: ${{ secrets.AWS_REGION_PREVIEW }}
      kube-config: ${{ secrets.KUBE_CONFIG_DATA_PREVIEW }}
      openid_client_id: ${{ secrets.OPENID_CLIENT_ID_PREVIEW }}
      openid_client_secret: ${{ secrets.OPENID_CLIENT_SECRET_PREVIEW }}
      openid_base_redirect_url: ${{ secrets.OPENID_LOGOUT_URL_PREVIEW }}
      openid_logout_url: ${{ secrets.OPENID_BASE_REDIRECT_URL_PREVIEW }}
      ga-tracking-id: ${{ secrets.GA_TRACKING_ID }}

  OSD-Functional-Test-Preview:
    needs: OS-OSD-Preview-Scheduled-Deployment
    uses: opensearch-project/dashboards-anywhere/.github/workflows/functional-test-template.yml@previewchangefeature
    with:
      endpoint: https://preview.playground.opensearch.org
    secrets:
      osd-user: ${{ secrets.OSD_USER }}
      osd-user-password: ${{ secrets.OSD_USER_PASSWORD }}